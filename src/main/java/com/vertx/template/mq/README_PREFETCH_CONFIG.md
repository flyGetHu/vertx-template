# RabbitMQ Prefetch Count é…ç½®è¯´æ˜

## ğŸ“‹ ä»€ä¹ˆæ˜¯Prefetch Count

Prefetch Count æ˜¯RabbitMQä¸­çš„QoSï¼ˆQuality of Serviceï¼‰è®¾ç½®ï¼Œç”¨äºæ§åˆ¶æ¶ˆè´¹è€…åŒæ—¶å¤„ç†çš„**æœªç¡®è®¤æ¶ˆæ¯æ•°é‡**ã€‚å®ƒæ˜¯å®ç°**æµé‡æ§åˆ¶**å’Œ**è´Ÿè½½å‡è¡¡**çš„å…³é”®æœºåˆ¶ã€‚

## ğŸ—ï¸ æ¶æ„è®¾è®¡

æœ¬MQç³»ç»Ÿé‡‡ç”¨**ç‹¬ç«‹é€šé“æ¶æ„**ï¼š
- âœ… **æ¯ä¸ªæ¶ˆè´¹è€…ç‹¬ç«‹Channel**ï¼šæ¯ä¸ª `@RabbitConsumer` éƒ½æœ‰ç‹¬ç«‹çš„RabbitMQClientå’ŒChannel
- âœ… **ä»…æ”¯æŒæ³¨è§£æ–¹å¼**ï¼šç»Ÿä¸€ä½¿ç”¨ `@RabbitConsumer` å£°æ˜å¼é…ç½®
- âœ… **ç®€åŒ–é…ç½®**ï¼šæ— éœ€è€ƒè™‘å…¨å±€prefetchï¼Œæ¯ä¸ªæ¶ˆè´¹è€…ç‹¬ç«‹æ§åˆ¶

### æ¶æ„ä¼˜åŠ¿
```
æ¶ˆè´¹è€…A â”€â”€â”€ ç‹¬ç«‹Channel â”€â”€â”€ RabbitMQ Broker
æ¶ˆè´¹è€…B â”€â”€â”€ ç‹¬ç«‹Channel â”€â”€â”€ RabbitMQ Broker
æ¶ˆè´¹è€…C â”€â”€â”€ ç‹¬ç«‹Channel â”€â”€â”€ RabbitMQ Broker
```

- **éš”ç¦»æ€§**ï¼šæ¶ˆè´¹è€…ä¹‹é—´å®Œå…¨ç‹¬ç«‹ï¼Œäº’ä¸å½±å“
- **å¯é æ€§**ï¼šå•ä¸ªæ¶ˆè´¹è€…æ•…éšœä¸å½±å“å…¶ä»–æ¶ˆè´¹è€…
- **æ‰©å±•æ€§**ï¼šä¾¿äºæ°´å¹³æ‰©å±•å’Œè´Ÿè½½å‡è¡¡

## ğŸ”§ å·¥ä½œåŸç†

### åŸºæœ¬æ¦‚å¿µ
- **é¢„å–æ¶ˆæ¯**ï¼šRabbitMQä¼šæå‰å‘é€æŒ‡å®šæ•°é‡çš„æ¶ˆæ¯ç»™æ¶ˆè´¹è€…
- **æµé‡æ§åˆ¶**ï¼šå½“æœªç¡®è®¤æ¶ˆæ¯è¾¾åˆ°prefetché™åˆ¶æ—¶ï¼ŒRabbitMQåœæ­¢å‘é€æ–°æ¶ˆæ¯
- **èƒŒå‹æœºåˆ¶**ï¼šé˜²æ­¢å¿«é€Ÿç”Ÿäº§è€…å‹å®æ…¢é€Ÿæ¶ˆè´¹è€…

### æ‰§è¡Œæµç¨‹
```
1. æ¶ˆè´¹è€…è®¾ç½® prefetchCount = 10
2. RabbitMQ å‘é€ 10 æ¡æ¶ˆæ¯ç»™æ¶ˆè´¹è€…
3. æ¶ˆè´¹è€…å¼€å§‹å¤„ç†æ¶ˆæ¯ï¼ˆä½†è¿˜æœªACKï¼‰
4. RabbitMQ åœæ­¢å‘é€æ–°æ¶ˆæ¯
5. æ¶ˆè´¹è€…ACKä¸€æ¡æ¶ˆæ¯åï¼ŒRabbitMQç»§ç»­å‘é€ä¸€æ¡æ–°æ¶ˆæ¯
6. ç»´æŒæœªç¡®è®¤æ¶ˆæ¯æ•°é‡ â‰¤ 10
```

## âš™ï¸ é…ç½®å‚æ•°è¯¦è§£

### prefetchCount å‚æ•°

| å€¼èŒƒå›´   | é€‚ç”¨åœºæ™¯       | ä¼˜åŠ¿               | åŠ£åŠ¿             |
| -------- | -------------- | ------------------ | ---------------- |
| `0`      | ä¸æ¨è         | æ— é™åˆ¶ï¼Œæœ€å¤§ååé‡ | å¯èƒ½å¯¼è‡´å†…å­˜æº¢å‡º |
| `1`      | å¤„ç†æ—¶é—´å·®å¼‚å¤§ | ä¸¥æ ¼è½®è¯¢ï¼Œå…¬å¹³åˆ†å‘ | ååé‡ä½         |
| `5-20`   | ä¸€èˆ¬ä¸šåŠ¡åœºæ™¯   | å¹³è¡¡æ€§èƒ½å’Œèµ„æº     | éœ€è¦æ ¹æ®ä¸šåŠ¡è°ƒä¼˜ |
| `50-100` | é«˜ååé‡åœºæ™¯   | é«˜æ€§èƒ½             | å†…å­˜æ¶ˆè€—å¤§       |
| `200+`   | æ‰¹å¤„ç†åœºæ™¯     | æé«˜ååé‡         | éœ€è¦å¤§é‡å†…å­˜     |

## ğŸ¯ æœ€ä½³å®è·µé…ç½®

### ç”Ÿäº§ç¯å¢ƒæ¨èé…ç½®

```java
// é«˜é¢‘åœºæ™¯ï¼ˆå¦‚ç”¨æˆ·è¡Œä¸ºæ—¥å¿—ï¼‰
@RabbitConsumer(
    queueName = "user.behavior.queue",
    prefetchCount = 50,
    autoAck = false
)

// æ™®é€šä¸šåŠ¡åœºæ™¯ï¼ˆå¦‚è®¢å•å¤„ç†ï¼‰
@RabbitConsumer(
    queueName = "order.process.queue",
    prefetchCount = 20,
    autoAck = false
)

// é‡å‹ä»»åŠ¡åœºæ™¯ï¼ˆå¦‚æ–‡ä»¶å¤„ç†ï¼‰
@RabbitConsumer(
    queueName = "file.process.queue",
    prefetchCount = 1,
    autoAck = false
)

// æ‰¹å¤„ç†åœºæ™¯ï¼ˆå¦‚æ•°æ®åŒæ­¥ï¼‰
@RabbitConsumer(
    queueName = "data.sync.queue",
    prefetchCount = 100,
    autoAck = false
)
```

### å¼€å‘/æµ‹è¯•ç¯å¢ƒé…ç½®

```java
@RabbitConsumer(
    queueName = "test.queue",
    prefetchCount = 5,          // è¾ƒå°å€¼ä¾¿äºè°ƒè¯•
    autoAck = true             // ç®€åŒ–è°ƒè¯•
)
```

## ğŸ“Š æ€§èƒ½å½±å“åˆ†æ

### 1. ååé‡ vs Prefetch Count

```
Prefetch = 1:    â–ˆâ–ˆâ–ˆâ–ˆ                    (åŸºçº¿ 100%)
Prefetch = 10:   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ                (200-300%)
Prefetch = 50:   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ            (300-400%)
Prefetch = 100:  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ        (400-500%)
Prefetch = 0:    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  (500%+ ä½†ä¸ç¨³å®š)
```

### 2. å†…å­˜æ¶ˆè€— vs Prefetch Count

```
æ¯æ¡æ¶ˆæ¯å‡è®¾ 1KBï¼š
Prefetch = 10:   çº¦ 10KB/Consumer
Prefetch = 50:   çº¦ 50KB/Consumer
Prefetch = 100:  çº¦ 100KB/Consumer
Prefetch = 1000: çº¦ 1MB/Consumer
```

## ğŸš¨ å¸¸è§é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ

### é—®é¢˜1ï¼šæ¶ˆæ¯å †ç§¯
**ç—‡çŠ¶**ï¼šé˜Ÿåˆ—ä¸­æ¶ˆæ¯æ•°é‡æŒç»­å¢é•¿
**åŸå› **ï¼šprefetchCountè®¾ç½®è¿‡å°ï¼Œæ¶ˆè´¹é€Ÿåº¦è·Ÿä¸ä¸Šç”Ÿäº§é€Ÿåº¦
**è§£å†³**ï¼šé€‚å½“å¢åŠ prefetchCountå€¼

### é—®é¢˜2ï¼šå†…å­˜æº¢å‡º
**ç—‡çŠ¶**ï¼šæ¶ˆè´¹è€…è¿›ç¨‹OOM
**åŸå› **ï¼šprefetchCountè®¾ç½®è¿‡å¤§ï¼Œæˆ–è®¾ç½®ä¸º0
**è§£å†³**ï¼šé™ä½prefetchCountå€¼ï¼Œå¢åŠ æ¶ˆè´¹è€…å®ä¾‹

### é—®é¢˜3ï¼šè´Ÿè½½ä¸å‡è¡¡
**ç—‡çŠ¶**ï¼šæŸäº›æ¶ˆè´¹è€…å¾ˆå¿™ï¼ŒæŸäº›å¾ˆé—²
**åŸå› **ï¼šæ¶ˆæ¯å¤„ç†æ—¶é—´å·®å¼‚å¤§ï¼ŒprefetchCountè®¾ç½®ä¸å½“
**è§£å†³**ï¼šè®¾ç½®prefetchCount=1ï¼Œå®ç°ä¸¥æ ¼è½®è¯¢

### é—®é¢˜4ï¼šå»¶è¿Ÿå¢åŠ 
**ç—‡çŠ¶**ï¼šæ¶ˆæ¯å¤„ç†å»¶è¿Ÿæ˜æ˜¾å¢åŠ 
**åŸå› **ï¼šprefetchCountè¿‡å¤§ï¼Œæ¶ˆæ¯åœ¨æ¶ˆè´¹è€…å†…å­˜ä¸­æ’é˜Ÿ
**è§£å†³**ï¼šé™ä½prefetchCountï¼Œä¼˜åŒ–æ¶ˆæ¯å¤„ç†é€»è¾‘

## ğŸ” ç›‘æ§æŒ‡æ ‡

### å…³é”®ç›‘æ§é¡¹
1. **é˜Ÿåˆ—æ¶ˆæ¯æ•°é‡**ï¼šç›‘æ§æ¶ˆæ¯å †ç§¯æƒ…å†µ
2. **æ¶ˆè´¹è€…å†…å­˜ä½¿ç”¨**ï¼šé˜²æ­¢å†…å­˜æº¢å‡º
3. **æ¶ˆæ¯å¤„ç†å»¶è¿Ÿ**ï¼šè¯„ä¼°æ€§èƒ½å½±å“
4. **æ¶ˆè´¹é€Ÿç‡**ï¼šTPS/QPSç›‘æ§
5. **æœªç¡®è®¤æ¶ˆæ¯æ•°é‡**ï¼šç›‘æ§prefetchæ•ˆæœ

### ç›‘æ§å‘Šè­¦é˜ˆå€¼å»ºè®®
```yaml
alerts:
  queue_messages: > 1000        # é˜Ÿåˆ—æ¶ˆæ¯å †ç§¯
  consumer_memory: > 80%        # æ¶ˆè´¹è€…å†…å­˜ä½¿ç”¨ç‡
  message_latency: > 30s        # æ¶ˆæ¯å¤„ç†å»¶è¿Ÿ
  unacked_messages: > prefetch*2 # æœªç¡®è®¤æ¶ˆæ¯æ•°é‡
```

## ğŸ›ï¸ è°ƒä¼˜æŒ‡å—

### ç¬¬ä¸€æ­¥ï¼šåŸºçº¿æµ‹è¯•
```java
@RabbitConsumer(
    queueName = "test.queue",
    prefetchCount = 20,    // ä»é»˜è®¤å€¼å¼€å§‹
    autoAck = false
)
```

### ç¬¬äºŒæ­¥ï¼šå‹åŠ›æµ‹è¯•
1. ç›‘æ§å…³é”®æŒ‡æ ‡ï¼ˆTPSã€å†…å­˜ã€å»¶è¿Ÿï¼‰
2. é€æ­¥è°ƒæ•´prefetchCountå€¼
3. è®°å½•ä¸åŒå€¼ä¸‹çš„æ€§èƒ½è¡¨ç°

### ç¬¬ä¸‰æ­¥ï¼šä¼˜åŒ–é€‰æ‹©
- **ä¼˜å…ˆçº§ï¼šååé‡** â†’ é€‚å½“å¢åŠ prefetchCount
- **ä¼˜å…ˆçº§ï¼šä½å»¶è¿Ÿ** â†’ é€‚å½“é™ä½prefetchCount
- **ä¼˜å…ˆçº§ï¼šç¨³å®šæ€§** â†’ é€‰æ‹©ä¸­ç­‰åä¿å®ˆçš„å€¼

### ç¬¬å››æ­¥ï¼šç”Ÿäº§éªŒè¯
- å°æµé‡ç°åº¦æµ‹è¯•
- ç›‘æ§å…³é”®æŒ‡æ ‡
- é€æ­¥æ‰©å¤§æµé‡

## ğŸ“š æ‰©å±•é˜…è¯»

- [RabbitMQ Consumer Prefetch](https://www.rabbitmq.com/consumer-prefetch.html)
- [RabbitMQ QoS Documentation](https://www.rabbitmq.com/confirms.html#channel-qos-prefetch)
- [Performance Tuning Guide](https://www.rabbitmq.com/performance-tuning.html)

---

**æ›´æ–°æ—¶é—´**: 2025-01-23
**æ¶æ„ç‰¹æ€§**: ç‹¬ç«‹é€šé“ã€æ³¨è§£é©±åŠ¨ã€ç®€åŒ–é…ç½®
**é…ç½®ç¤ºä¾‹**: å‚è§ `ExampleMessageConsumer.java`
