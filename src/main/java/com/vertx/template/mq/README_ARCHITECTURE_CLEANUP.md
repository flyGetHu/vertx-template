# MQæ¶æ„ä¼˜åŒ–ï¼šç‹¬ç«‹é€šé“ + çº¯æ³¨è§£é©±åŠ¨

## ğŸ¯ ä¼˜åŒ–ç›®æ ‡

åŸºäºä»¥ä¸‹è®¾è®¡å†³ç­–è¿›è¡Œæ¶æ„ä¼˜åŒ–ï¼š
1. **ä»…æ”¯æŒæ³¨è§£æ–¹å¼** - ç»Ÿä¸€ä½¿ç”¨ `@RabbitConsumer` å£°æ˜å¼é…ç½®
2. **æ¯ä¸ªæ¶ˆè´¹è€…ç‹¬ç«‹é€šé“** - æä¾›æ›´å¥½çš„éš”ç¦»æ€§å’Œå¯é æ€§

## ğŸ—ï¸ æ¶æ„ç‰¹ç‚¹

### ç‹¬ç«‹é€šé“æ¶æ„
```
åº”ç”¨è¿›ç¨‹
â”œâ”€â”€ æ¶ˆè´¹è€…A â”€â”€â”€ ç‹¬ç«‹RabbitMQClient â”€â”€â”€ ç‹¬ç«‹Channel â”€â”€â”€ RabbitMQ Broker
â”œâ”€â”€ æ¶ˆè´¹è€…B â”€â”€â”€ ç‹¬ç«‹RabbitMQClient â”€â”€â”€ ç‹¬ç«‹Channel â”€â”€â”€ RabbitMQ Broker
â””â”€â”€ æ¶ˆè´¹è€…C â”€â”€â”€ ç‹¬ç«‹RabbitMQClient â”€â”€â”€ ç‹¬ç«‹Channel â”€â”€â”€ RabbitMQ Broker
```

### ä¼˜åŠ¿åˆ†æ

| ç‰¹æ€§       | ä¼ ç»Ÿå…±äº«Channel          | ç‹¬ç«‹Channelæ¶æ„              |
| ---------- | ------------------------ | ---------------------------- |
| **éš”ç¦»æ€§** | âŒ æ¶ˆè´¹è€…é—´ç›¸äº’å½±å“       | âœ… å®Œå…¨ç‹¬ç«‹ï¼Œäº’ä¸å½±å“         |
| **å¯é æ€§** | âŒ å•ç‚¹æ•…éšœå½±å“æ‰€æœ‰æ¶ˆè´¹è€… | âœ… å•ä¸ªæ¶ˆè´¹è€…æ•…éšœä¸å½±å“å…¶ä»–   |
| **æ‰©å±•æ€§** | âŒ éœ€è¦è€ƒè™‘å…¨å±€é…ç½®       | âœ… æ¯ä¸ªæ¶ˆè´¹è€…ç‹¬ç«‹é…ç½®         |
| **è°ƒè¯•æ€§** | âŒ éš¾ä»¥å®šä½å…·ä½“æ¶ˆè´¹è€…é—®é¢˜ | âœ… é—®é¢˜å®šä½ç²¾ç¡®åˆ°å…·ä½“æ¶ˆè´¹è€…   |
| **æ€§èƒ½**   | âœ… èµ„æºå…±äº«               | âš–ï¸ ç•¥å¤šèµ„æºæ¶ˆè€—ï¼Œä½†éš”ç¦»æ€§æ›´å¥½ |

## ğŸš€ æœ¬æ¬¡ä¼˜åŒ–å†…å®¹

### 1. ç§»é™¤globalPrefetché…ç½®
**åŸå› **ï¼šæ¯ä¸ªæ¶ˆè´¹è€…ä½¿ç”¨ç‹¬ç«‹Channelï¼ŒglobalPrefetchæ¦‚å¿µä¸å†é€‚ç”¨

**å˜æ›´å¯¹æ¯”**ï¼š
```java
// ğŸ”´ ä¼˜åŒ–å‰
@RabbitConsumer(
    queueName = "test.queue",
    prefetchCount = 20,
    globalPrefetch = false  // å†—ä½™é…ç½®
)

// âœ… ä¼˜åŒ–å
@RabbitConsumer(
    queueName = "test.queue",
    prefetchCount = 20      // è‡ªåŠ¨åº”ç”¨åˆ°ç‹¬ç«‹Channel
)
```

### 2. ç®€åŒ–QoSè®¾ç½®é€»è¾‘
**ä¼˜åŒ–å‰**ï¼š
```java
Future.await(client.basicQos(prefetchCount, globalPrefetch));
```

**ä¼˜åŒ–å**ï¼š
```java
Future.await(client.basicQos(prefetchCount));
```

### 3. æ›´æ–°æ–‡æ¡£å’Œç¤ºä¾‹
- ç§»é™¤æ‰€æœ‰globalPrefetchç›¸å…³è¯´æ˜
- å¼ºè°ƒç‹¬ç«‹é€šé“æ¶æ„çš„ä¼˜åŠ¿
- ç®€åŒ–é…ç½®ç¤ºä¾‹

## ğŸ“‹ æ¶ˆè´¹è€…å¼€å‘æŒ‡å—

### æ ‡å‡†æ¶ˆè´¹è€…æ¨¡æ¿
```java
@Slf4j
@Singleton
@RabbitConsumer(
    queueName = "your.business.queue",
    enabled = true,
    autoAck = false,              // æ¨èæ‰‹åŠ¨ç¡®è®¤
    maxRetries = 3,
    retryDelayMs = 1000,
    prefetchCount = 20,           // æ ¹æ®ä¸šåŠ¡è°ƒæ•´
    description = "ä¸šåŠ¡æè¿°"
)
public class YourBusinessConsumer implements MessageConsumer {

    @Override
    public String getConsumerName() {
        return "your-business-consumer";
    }

    @Override
    public Boolean handleMessage(RabbitMQMessage message) {
        try {
            // ä¸šåŠ¡é€»è¾‘å¤„ç†
            log.info("å¤„ç†æ¶ˆæ¯: {}", message.body().toString());

            // è¿”å›trueè¡¨ç¤ºå¤„ç†æˆåŠŸ
            return true;

        } catch (Exception e) {
            log.error("æ¶ˆæ¯å¤„ç†å¤±è´¥", e);

            // è¿”å›falseè¡¨ç¤ºå¤„ç†å¤±è´¥ï¼Œä¼šè§¦å‘é‡è¯•
            return false;
        }
    }

    @Override
    public void onStart() {
        log.info("æ¶ˆè´¹è€…å¯åŠ¨ï¼š{}", getConsumerName());
    }

    @Override
    public void onStop() {
        log.info("æ¶ˆè´¹è€…åœæ­¢ï¼š{}", getConsumerName());
    }
}
```

### é…ç½®æœ€ä½³å®è·µ

| ä¸šåŠ¡åœºæ™¯                   | prefetchCount | autoAck | maxRetries | è¯´æ˜             |
| -------------------------- | ------------- | ------- | ---------- | ---------------- |
| **é«˜é¢‘è½»é‡çº§**ï¼ˆå¦‚æ—¥å¿—ï¼‰   | 50-100        | false   | 1          | è¿½æ±‚é«˜ååé‡     |
| **æ™®é€šä¸šåŠ¡**ï¼ˆå¦‚è®¢å•ï¼‰     | 10-30         | false   | 3          | å¹³è¡¡æ€§èƒ½å’Œå¯é æ€§ |
| **é‡å‹ä»»åŠ¡**ï¼ˆå¦‚æ–‡ä»¶å¤„ç†ï¼‰ | 1-5           | false   | 5          | é¿å…èµ„æºè¿‡è½½     |
| **æ‰¹å¤„ç†**ï¼ˆå¦‚æ•°æ®åŒæ­¥ï¼‰   | 100+          | false   | 0          | æœ€å¤§åŒ–ååé‡     |
| **æµ‹è¯•è°ƒè¯•**               | 1-5           | true    | 0          | ä¾¿äºè°ƒè¯•         |

## ğŸ›ï¸ ç³»ç»Ÿå¯åŠ¨æµç¨‹

### 1. è‡ªåŠ¨æ‰«æå¯åŠ¨
```java
// MqVerticle.java ä¸­çš„å¯åŠ¨æµç¨‹
mqManager.scanAndStartConsumers("com.vertx.template");
```

### 2. æ¶ˆè´¹è€…åˆ›å»ºæµç¨‹
```
1. æ‰«æ @RabbitConsumer æ³¨è§£ç±»
2. é€šè¿‡ Guice åˆ›å»ºæ¶ˆè´¹è€…å®ä¾‹
3. ä¸ºæ¯ä¸ªæ¶ˆè´¹è€…åˆ›å»ºç‹¬ç«‹ RabbitMQClient
4. è®¾ç½®ç‹¬ç«‹çš„ QoS (prefetchCount)
5. åˆ›å»º RabbitMQConsumer å¹¶ç»‘å®šé˜Ÿåˆ—
6. å¯åŠ¨æ¶ˆæ¯ç›‘å¬
```

### 3. ç”Ÿå‘½å‘¨æœŸç®¡ç†
```java
// å¯åŠ¨å•ä¸ªæ¶ˆè´¹è€…
mqManager.startConsumer("consumer-name");

// åœæ­¢å•ä¸ªæ¶ˆè´¹è€…
mqManager.stopConsumer("consumer-name");

// åœæ­¢æ‰€æœ‰æ¶ˆè´¹è€…
mqManager.stopAllConsumers();
```

## ğŸ” ç›‘æ§å’Œè°ƒè¯•

### æ¶ˆè´¹è€…çŠ¶æ€æŸ¥è¯¢
```java
// è·å–æ´»è·ƒæ¶ˆè´¹è€…æ•°é‡
int activeCount = mqManager.getActiveConsumerCount();

// è·å–æ³¨å†Œæ¶ˆè´¹è€…æ•°é‡
int registeredCount = mqManager.getRegisteredConsumerCount();

// æ£€æŸ¥ç‰¹å®šæ¶ˆè´¹è€…çŠ¶æ€
boolean isRunning = mqManager.isConsumerActive("consumer-name");
```

### å…³é”®ç›‘æ§æŒ‡æ ‡
1. **ç‹¬ç«‹Channelæ•°é‡** = æ´»è·ƒæ¶ˆè´¹è€…æ•°é‡
2. **æ¯ä¸ªæ¶ˆè´¹è€…çš„QoSè®¾ç½®** = prefetchCountå€¼
3. **æ¶ˆè´¹è€…çº§åˆ«çš„é”™è¯¯ç‡**
4. **æ¶ˆè´¹è€…çº§åˆ«çš„å¤„ç†å»¶è¿Ÿ**
5. **æœªç¡®è®¤æ¶ˆæ¯æ•°é‡**ï¼ˆæŒ‰æ¶ˆè´¹è€…åˆ†åˆ«ç»Ÿè®¡ï¼‰

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. èµ„æºç®¡ç†
- **ä¼˜åŠ¿**ï¼šæ•…éšœéš”ç¦»ï¼Œé—®é¢˜å®šä½ç²¾ç¡®
- **æˆæœ¬**ï¼šæ¯ä¸ªæ¶ˆè´¹è€…éœ€è¦ç‹¬ç«‹TCPè¿æ¥
- **å»ºè®®**ï¼šåˆç†è§„åˆ’æ¶ˆè´¹è€…æ•°é‡ï¼Œé¿å…è¿‡å¤šè¿æ¥

### 2. é…ç½®ç®¡ç†
- **ç®€åŒ–**ï¼šæ— éœ€è€ƒè™‘globalé…ç½®
- **ç‹¬ç«‹**ï¼šæ¯ä¸ªæ¶ˆè´¹è€…å¯ä»¥ç‹¬ç«‹è°ƒä¼˜
- **å»ºè®®**ï¼šå»ºç«‹é…ç½®æ¨¡æ¿å’Œæœ€ä½³å®è·µ

### 3. é”™è¯¯å¤„ç†
- **éš”ç¦»æ€§**ï¼šå•ä¸ªæ¶ˆè´¹è€…é”™è¯¯ä¸å½±å“å…¶ä»–
- **ç›‘æ§**ï¼šéœ€è¦åˆ†æ¶ˆè´¹è€…ç›‘æ§é”™è¯¯ç‡
- **å»ºè®®**ï¼šå»ºç«‹æ¶ˆè´¹è€…çº§åˆ«çš„å‘Šè­¦æœºåˆ¶

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [Prefetch Count é…ç½®è¯¦è§£](README_PREFETCH_CONFIG.md)
- [ACKæœºåˆ¶ä¿®å¤è¯´æ˜](README_ACK_FIX.md)
- [æ¶ˆè´¹è€…å¼€å‘ç¤ºä¾‹](example/ExampleMessageConsumer.java)

---

**æ›´æ–°æ—¶é—´**: 2025-01-23
**æ¶æ„ç‰ˆæœ¬**: v2.0 - ç‹¬ç«‹é€šé“ + çº¯æ³¨è§£é©±åŠ¨
**ä¸»è¦å˜æ›´**: ç§»é™¤globalPrefetchï¼Œç®€åŒ–é…ç½®ï¼Œå¼ºåŒ–éš”ç¦»æ€§
