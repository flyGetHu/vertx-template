---
description: 
globs: 
alwaysApply: true
---
# Vert.x é¡¹ç›®æ¶æ„è§„èŒƒ

## ğŸ“ é¡¹ç›®ç»“æ„ï¼ˆç¬¦åˆé˜¿é‡Œå·´å·´è§„èŒƒï¼‰

### æ ¸å¿ƒç›®å½•ç»“æ„
```
src/main/java/com/vertx/template/
â”œâ”€â”€ Run.java                    # åº”ç”¨å…¥å£
â”œâ”€â”€ config/                     # é…ç½®æ¨¡å—
â”‚   â”œâ”€â”€ ConfigLoader.java       # é…ç½®åŠ è½½å™¨
â”‚   â”œâ”€â”€ DatabaseConfig.java     # æ•°æ®åº“é…ç½®
â”‚   â””â”€â”€ RouterConfig.java       # è·¯ç”±é…ç½®
â”œâ”€â”€ controller/                 # æ§åˆ¶å™¨å±‚ï¼ˆWebå±‚ï¼‰
â”‚   â”œâ”€â”€ AuthController.java     # è®¤è¯æ§åˆ¶å™¨
â”‚   â”œâ”€â”€ UserController.java     # ç”¨æˆ·æ§åˆ¶å™¨
â”‚   â””â”€â”€ ProductController.java  # äº§å“æ§åˆ¶å™¨
â”œâ”€â”€ service/                    # æœåŠ¡å±‚ï¼ˆä¸šåŠ¡é€»è¾‘å±‚ï¼‰
â”‚   â”œâ”€â”€ impl/                   # æœåŠ¡å®ç°ç±»
â”‚   â””â”€â”€ UserService.java        # ç”¨æˆ·æœåŠ¡æ¥å£
â”œâ”€â”€ repository/                 # æ•°æ®è®¿é—®å±‚ï¼ˆæŒä¹…å±‚ï¼‰
â”‚   â”œâ”€â”€ common/                 # é€šç”¨ä»“å‚¨æ¥å£
â”‚   â”œâ”€â”€ impl/                   # æ•°æ®è®¿é—®å®ç°ç±»
â”‚   â””â”€â”€ UserRepository.java     # ç”¨æˆ·ä»“å‚¨æ¥å£
â”œâ”€â”€ model/                      # æ•°æ®æ¨¡å‹å±‚
â”‚   â”œâ”€â”€ dto/                    # æ•°æ®ä¼ è¾“å¯¹è±¡
â”‚   â”œâ”€â”€ entity/                 # æ•°æ®åº“å®ä½“å¯¹è±¡
â”‚   â”œâ”€â”€ vo/                     # è§†å›¾å¯¹è±¡
â”‚   â””â”€â”€ bo/                     # ä¸šåŠ¡å¯¹è±¡
â”œâ”€â”€ router/                     # è·¯ç”±ç³»ç»Ÿ
â”‚   â”œâ”€â”€ annotation/             # è·¯ç”±æ³¨è§£
â”‚   â”œâ”€â”€ handler/                # è·¯ç”±å¤„ç†å™¨
â”‚   â””â”€â”€ cache/                  # è·¯ç”±ç¼“å­˜
â”œâ”€â”€ middleware/                 # ä¸­é—´ä»¶ç³»ç»Ÿ
â”‚   â”œâ”€â”€ auth/                   # è®¤è¯ä¸­é—´ä»¶
â”‚   â”œâ”€â”€ ratelimit/              # é™æµä¸­é—´ä»¶
â”‚   â””â”€â”€ core/                   # æ ¸å¿ƒä¸­é—´ä»¶
â”œâ”€â”€ di/                         # ä¾èµ–æ³¨å…¥æ¨¡å—
â”œâ”€â”€ exception/                  # å¼‚å¸¸å®šä¹‰
â”œâ”€â”€ constants/                  # å¸¸é‡å®šä¹‰
â”œâ”€â”€ utils/                      # å·¥å…·ç±»
â””â”€â”€ verticle/                   # Verticleç»„ä»¶
```

### åŒ…å‘½åè§„èŒƒ
| åŒ…ç±»å‹ | å‘½åè§„åˆ™ | ç¤ºä¾‹ | è¯´æ˜ |
|--------|----------|------|------|
| **åŸºç¡€åŒ…** | `com.{å…¬å¸}.{é¡¹ç›®}` | `com.vertx.template` | å…¬å¸åŸŸåå€’ç½®+é¡¹ç›®å |
| **æ§åˆ¶å™¨åŒ…** | `{åŸºç¡€åŒ…}.controller` | `com.vertx.template.controller` | Webå±‚æ§åˆ¶å™¨ |
| **æœåŠ¡åŒ…** | `{åŸºç¡€åŒ…}.service` | `com.vertx.template.service` | ä¸šåŠ¡é€»è¾‘å±‚ |
| **æ•°æ®è®¿é—®åŒ…** | `{åŸºç¡€åŒ…}.repository` | `com.vertx.template.repository` | æ•°æ®è®¿é—®å±‚ |
| **å®ä½“åŒ…** | `{åŸºç¡€åŒ…}.model.entity` | `com.vertx.template.model.entity` | æ•°æ®åº“å®ä½“ |
| **DTOåŒ…** | `{åŸºç¡€åŒ…}.model.dto` | `com.vertx.template.model.dto` | æ•°æ®ä¼ è¾“å¯¹è±¡ |

## ğŸ—ï¸ MVCæ¶æ„æ¨¡å¼

### åˆ†å±‚æ¶æ„èŒè´£
| å±‚çº§ | èŒè´£ | ç¤ºä¾‹æ–‡ä»¶ | é˜¿é‡Œè§„èŒƒå¯¹åº”å±‚ |
|------|------|----------|---------------|
| **Controller** | æ¥æ”¶HTTPè¯·æ±‚ï¼Œå‚æ•°éªŒè¯ï¼Œè°ƒç”¨æœåŠ¡å±‚ | `UserController.java` | Webå±‚ |
| **Service** | ä¸šåŠ¡é€»è¾‘å¤„ç†ï¼Œæ•°æ®è½¬æ¢ | `UserService.java` | Serviceå±‚ |
| **Repository** | æ•°æ®è®¿é—®ï¼Œå¤–éƒ¨APIè°ƒç”¨ | `UserRepository.java` | DAOå±‚ |
| **DTO** | æ•°æ®ä¼ è¾“å¯¹è±¡ï¼Œç”¨äºå±‚é—´æ•°æ®ä¼ é€’ | `UserDto.java` | é¢†åŸŸæ¨¡å‹ |
| **Entity** | æ•°æ®åº“å®ä½“å¯¹è±¡ï¼Œä¸æ•°æ®è¡¨å¯¹åº” | `User.java` | é¢†åŸŸæ¨¡å‹ |

### æ•°æ®æµç¨‹
1. **è¯·æ±‚æ¥æ”¶** â†’ è·¯ç”±å±‚æ¥æ”¶HTTPè¯·æ±‚
2. **å‚æ•°éªŒè¯** â†’ æ§åˆ¶å™¨éªŒè¯è¯·æ±‚å‚æ•°
3. **ä¸šåŠ¡å¤„ç†** â†’ æœåŠ¡å±‚æ‰§è¡Œä¸šåŠ¡é€»è¾‘
4. **æ•°æ®è®¿é—®** â†’ ä»“åº“å±‚å¤„ç†æ•°æ®æ“ä½œ
5. **ç»“æœè¿”å›** â†’ å“åº”åŒ…è£…å™¨ç»Ÿä¸€è¿”å›æ ¼å¼
6. **å¼‚å¸¸å¤„ç†** â†’ å…¨å±€å¼‚å¸¸å¤„ç†å™¨å¤„ç†é”™è¯¯

### å±‚é—´è°ƒç”¨è§„åˆ™
```java
// âœ… æ­£ç¡®çš„è°ƒç”¨æ–¹å‘
Controller â†’ Service â†’ Repository

// âŒ ç¦æ­¢çš„è°ƒç”¨
Repository â†’ Service  // ä¸‹å±‚ä¸èƒ½è°ƒç”¨ä¸Šå±‚
Controller â†’ Repository  // è·¨å±‚è°ƒç”¨
```

## ğŸ’‰ ä¾èµ–æ³¨å…¥ç³»ç»Ÿï¼ˆGoogle Guiceï¼‰

### æ ¸å¿ƒæ³¨è§£
| æ³¨è§£ | ç”¨é€” | ç¤ºä¾‹ |
|------|------|------|
| `@Inject` | æ ‡è®°ä¾èµ–æ³¨å…¥ç‚¹ | `@Inject public UserController(UserService service)` |
| `@Singleton` | å•ä¾‹æ¨¡å¼ | `@Singleton public class UserServiceImpl` |
| `@Provides` | å·¥å‚æ–¹æ³• | `@Provides Router provideRouter()` |

### ä¾èµ–æ³¨å…¥é…ç½®
```java
// 1. æœåŠ¡æ¥å£å®šä¹‰
public interface UserService {
    User getUserById(String id);
    List<User> getAllUsers();
}

// 2. æœåŠ¡å®ç°
@Singleton
public class UserServiceImpl implements UserService {
    private final UserRepository userRepository;

    @Inject
    public UserServiceImpl(UserRepository userRepository) {
        this.userRepository = userRepository;
    }
}

// 3. æ¨¡å—é…ç½®
public class AppModule extends AbstractModule {
    @Override
    protected void configure() {
        bind(UserService.class).to(UserServiceImpl.class);
        bind(UserRepository.class).to(UserRepositoryImpl.class);
    }
}

// 4. æ§åˆ¶å™¨æ³¨å…¥
@RestController
@Singleton
public class UserController {
    private final UserService userService;

    @Inject
    public UserController(UserService userService) {
        this.userService = userService;
    }
}
```

### æ·»åŠ æ–°æœåŠ¡æ­¥éª¤
1. **å®šä¹‰æ¥å£**ï¼šåˆ›å»ºæœåŠ¡æ¥å£
2. **å®ç°æœåŠ¡**ï¼šåˆ›å»ºå®ç°ç±»å¹¶æ·»åŠ  `@Singleton` å’Œ `@Inject`
3. **é…ç½®ç»‘å®š**ï¼šåœ¨ `AppModule` ä¸­æ·»åŠ ç»‘å®š
4. **æ³¨å…¥ä½¿ç”¨**ï¼šåœ¨éœ€è¦çš„åœ°æ–¹é€šè¿‡æ„é€ å‡½æ•°æ³¨å…¥

## ğŸ›£ï¸ è·¯ç”±ç³»ç»Ÿï¼ˆæ³¨è§£é©±åŠ¨ï¼‰

### è·¯ç”±æ³¨è§£ç³»ç»Ÿ
| æ³¨è§£ | ç”¨é€” | ç¤ºä¾‹ |
|------|------|------|
| `@RestController` | æ ‡è®°RESTæ§åˆ¶å™¨ | `@RestController` |
| `@RequestMapping` | å®šä¹‰åŸºç¡€è·¯å¾„ | `@RequestMapping("/api/users")` |
| `@GetMapping` | GETè¯·æ±‚æ˜ å°„ | `@GetMapping("/:id")` |
| `@PostMapping` | POSTè¯·æ±‚æ˜ å°„ | `@PostMapping("")` |
| `@PathParam` | è·¯å¾„å‚æ•° | `@PathParam("id") String id` |
| `@QueryParam` | æŸ¥è¯¢å‚æ•° | `@QueryParam("name") String name` |
| `@RequestBody` | è¯·æ±‚ä½“ | `@RequestBody User user` |
| `@Valid` | å‚æ•°æ ¡éªŒ | `@Valid @RequestBody CreateUserRequest request` |

### è·¯ç”±å¤„ç†æµç¨‹
```
HTTPè¯·æ±‚ â†’ AnnotationRouterHandler â†’ å‚æ•°è§£æ â†’ æ§åˆ¶å™¨æ–¹æ³• â†’ ResponseHandler â†’ HTTPå“åº”
```

### æ§åˆ¶å™¨æ ‡å‡†æ¨¡æ¿
```java
@RestController
@RequestMapping("/api/users")
@Singleton
public class UserController {

    private final UserService userService;

    @Inject
    public UserController(UserService userService) {
        this.userService = userService;
    }

    @GetMapping("")
    public List<User> getUsers(
        @QueryParam("page") Integer page,
        @QueryParam("size") Integer size) {
        return Future.await(userService.getUsers(page, size));
    }

    @GetMapping("/:id")
    public User getUserById(@PathParam("id") String id) {
        return Future.await(userService.getUserById(id));
    }

    @PostMapping("")
    public User createUser(@Valid @RequestBody CreateUserRequest request) {
        return Future.await(userService.createUser(request));
    }

    @PutMapping("/:id")
    public User updateUser(
        @PathParam("id") String id,
        @Valid @RequestBody UpdateUserRequest request) {
        return Future.await(userService.updateUser(id, request));
    }

    @DeleteMapping("/:id")
    public void deleteUser(@PathParam("id") String id) {
        Future.await(userService.deleteUser(id));
    }
}
```

## ğŸ” è®¤è¯ä¸æˆæƒç³»ç»Ÿ

### è®¤è¯æ³¨è§£
| æ³¨è§£ | ç”¨é€” | ç¤ºä¾‹ |
|------|------|------|
| `@RequireAuth` | æ ‡è®°éœ€è¦è®¤è¯çš„æ¥å£ | `@RequireAuth(AuthType.JWT)` |

### è®¤è¯ç±»å‹
| ç±»å‹ | è¯´æ˜ | ä½¿ç”¨åœºæ™¯ |
|------|------|----------|
| `JWT` | JWTä»¤ç‰Œè®¤è¯ | æ ‡å‡†APIè®¤è¯ï¼ˆé»˜è®¤ï¼‰ |
| `BASIC` | åŸºç¡€è®¤è¯ | ç®€å•çš„ç”¨æˆ·åå¯†ç è®¤è¯ |
| `NONE` | æ— éœ€è®¤è¯ | å…¬å¼€æ¥å£ |

### è®¤è¯é…ç½®ç¤ºä¾‹
```java
// ç±»çº§åˆ«è®¤è¯ - æ‰€æœ‰æ–¹æ³•éƒ½éœ€è¦JWTè®¤è¯
@RestController
@RequestMapping("/api/admin")
@RequireAuth(AuthType.JWT)
public class AdminController {
    // æ‰€æœ‰æ–¹æ³•éƒ½éœ€è¦JWTè®¤è¯
}

// æ–¹æ³•çº§åˆ«è®¤è¯ - è¦†ç›–ç±»çº§åˆ«é…ç½®
@RestController
@RequestMapping("/api/public")
@RequireAuth(AuthType.NONE)
public class PublicController {

    @GetMapping("/info")
    public String getInfo() {
        return "å…¬å¼€ä¿¡æ¯";
    }

    @PostMapping("/sensitive")
    @RequireAuth(AuthType.JWT)
    public String getSensitiveData() {
        return "æ•æ„Ÿæ•°æ®";
    }
}
```

## âš¡ é™æµç³»ç»Ÿ

### é™æµæ³¨è§£é…ç½®
```java
@RestController
@RequestMapping("/api/users")
@RateLimit(limit = 1000, window = 3600) // ç±»çº§åˆ«ï¼šæ¯å°æ—¶1000æ¬¡
public class UserController {

    @GetMapping("")
    public List<User> getUsers() {
        // ç»§æ‰¿ç±»çº§åˆ«é™æµ
        return userService.getUsers();
    }

    @PostMapping("")
    @RateLimit(
        limit = 10,
        window = 60,
        dimension = RateLimitDimension.USER,
        message = "åˆ›å»ºç”¨æˆ·è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•"
    )
    public User createUser(@RequestBody User user) {
        // æ–¹æ³•çº§åˆ«é™æµï¼šæ¯åˆ†é’Ÿ10æ¬¡ï¼ŒæŒ‰ç”¨æˆ·é™æµ
        return userService.createUser(user);
    }
}
```

### é™æµç®—æ³•ç±»å‹
| ç±»å‹ | è¯´æ˜ | é€‚ç”¨åœºæ™¯ |
|------|------|----------|
| `FIXED_WINDOW` | å›ºå®šçª—å£ç®—æ³• | ç®€å•é™æµåœºæ™¯ |
| `SLIDING_WINDOW` | æ»‘åŠ¨çª—å£ç®—æ³• | ç²¾ç¡®é™æµåœºæ™¯ |
| `TOKEN_BUCKET` | ä»¤ç‰Œæ¡¶ç®—æ³• | å…è®¸çªå‘æµé‡ |
| `LEAKY_BUCKET` | æ¼æ¡¶ç®—æ³• | å¹³æ»‘é™æµ |

## âš™ï¸ é…ç½®ç®¡ç†ç³»ç»Ÿ

### YAMLé…ç½®ç»“æ„
```yaml
# config.yml
server:
  port: 8888
  host: localhost

logging:
  enabled: true
  level: INFO
  request_log: true

cors:
  enabled: true
  allowed_origins: "*"
  allowed_methods:
    - GET
    - POST
    - PUT
    - DELETE

database:
  host: localhost
  port: 3306
  username: root
  password: password
  database: vertx_template
```

### é…ç½®åŠ è½½å’Œä½¿ç”¨
```java
// é…ç½®åŠ è½½
JsonObject config = Future.await(ConfigLoader.loadConfig(vertx));

// é…ç½®ä½¿ç”¨
JsonObject serverConfig = config.getJsonObject("server", new JsonObject());
int port = serverConfig.getInteger("port", 8888);
String host = serverConfig.getString("host", "localhost");

// è·å–åµŒå¥—é…ç½®
JsonObject corsConfig = config.getJsonObject("cors", new JsonObject());
boolean corsEnabled = corsConfig.getBoolean("enabled", true);
```

### é…ç½®ä¼˜å…ˆçº§
1. **ç³»ç»Ÿå±æ€§**ï¼ˆ`-D`å‚æ•°ï¼‰- æœ€é«˜ä¼˜å…ˆçº§
2. **ç¯å¢ƒå˜é‡** - ä¸­ç­‰ä¼˜å…ˆçº§
3. **é…ç½®æ–‡ä»¶**ï¼ˆ`config.yml`ï¼‰- æœ€ä½ä¼˜å…ˆçº§

## ğŸŒ ä¸­é—´ä»¶ç³»ç»Ÿ

### å…¨å±€ä¸­é—´ä»¶
```java
@Singleton
public class GlobalMiddleware {

    @Inject
    public GlobalMiddleware(Vertx vertx, Router router, JsonObject config) {
        this.vertx = vertx;
        this.router = router;
        this.config = config;
    }

    public void setupMiddleware() {
        // CORSä¸­é—´ä»¶
        setupCors();

        // è¯·æ±‚ä½“è§£æä¸­é—´ä»¶
        router.route().handler(BodyHandler.create());

        // è¯·æ±‚æ—¥å¿—ä¸­é—´ä»¶
        setupRequestLogging();

        // è®¤è¯ä¸­é—´ä»¶
        setupAuthentication();

        // é™æµä¸­é—´ä»¶
        setupRateLimit();
    }
}
```

### ä¸­é—´ä»¶æ‰§è¡Œé¡ºåº
```
è¯·æ±‚ â†’ CORS â†’ è¯·æ±‚ä½“è§£æ â†’ è¯·æ±‚æ—¥å¿— â†’ è®¤è¯ â†’ é™æµ â†’ æ§åˆ¶å™¨ â†’ å“åº”å¤„ç† â†’ å“åº”
```

## ğŸ“Š åº”ç”¨å¯åŠ¨æµç¨‹

### æ ‡å‡†å¯åŠ¨åºåˆ—
```java
// Run.java - åº”ç”¨å…¥å£
public class Run {
    public static void main(String[] args) {
        // 1. åˆ›å»ºVertxå®ä¾‹
        Vertx vertx = Vertx.vertx(new VertxOptions()
            .setEventLoopPoolSize(1)
            .setWorkerPoolSize(1));

        // 2. ä½¿ç”¨è™šæ‹Ÿçº¿ç¨‹éƒ¨ç½²MainVerticle
        Thread.startVirtualThread(() -> {
            try {
                Future.await(vertx.deployVerticle(new MainVerticle()));
                log.info("åº”ç”¨å¯åŠ¨æˆåŠŸ");
            } catch (Exception e) {
                log.error("åº”ç”¨å¯åŠ¨å¤±è´¥", e);
                System.exit(1);
            }
        });
    }
}

// MainVerticle.java - ä¸»Verticle
public class MainVerticle extends AbstractVerticle {
    @Override
    public Future<Void> start() {
        return ConfigLoader.loadConfig(vertx)
            .compose(this::setupDependencyInjection)
            .compose(this::setupRouterAndMiddleware)
            .compose(this::startHttpServer)
            .compose(result -> {
                log.info("HTTPæœåŠ¡å™¨å¯åŠ¨æˆåŠŸï¼Œç«¯å£: {}", getPort());
                return Future.succeededFuture();
            });
    }
}
```

## ğŸ“‹ æ¶æ„è®¾è®¡åŸåˆ™

### SOLIDåŸåˆ™åº”ç”¨
- **å•ä¸€èŒè´£åŸåˆ™**ï¼šæ¯ä¸ªç±»åªè´Ÿè´£ä¸€ä¸ªåŠŸèƒ½é¢†åŸŸ
- **å¼€é—­åŸåˆ™**ï¼šé€šè¿‡æ¥å£å’Œä¾èµ–æ³¨å…¥æ”¯æŒæ‰©å±•
- **é‡Œæ°æ›¿æ¢åŸåˆ™**ï¼šæ¥å£å’Œå®ç°ç±»å¯ä»¥äº’ç›¸æ›¿æ¢
- **æ¥å£éš”ç¦»åŸåˆ™**ï¼šæ¥å£è®¾è®¡ç²¾ç®€ï¼Œé¿å…è‡ƒè‚¿
- **ä¾èµ–å€’ç½®åŸåˆ™**ï¼šä¾èµ–æŠ½è±¡è€Œéå…·ä½“å®ç°

### æ¶æ„è´¨é‡è¦æ±‚
- **å¯æµ‹è¯•æ€§**ï¼šæ‰€æœ‰ç»„ä»¶éƒ½æ”¯æŒå•å…ƒæµ‹è¯•
- **å¯ç»´æŠ¤æ€§**ï¼šä»£ç ç»“æ„æ¸…æ™°ï¼ŒèŒè´£åˆ†ç¦»
- **å¯æ‰©å±•æ€§**ï¼šé€šè¿‡æ¥å£å’Œæ³¨è§£æ”¯æŒåŠŸèƒ½æ‰©å±•
- **æ€§èƒ½ä¼˜åŒ–**ï¼šå……åˆ†åˆ©ç”¨å¼‚æ­¥å’Œè™šæ‹Ÿçº¿ç¨‹ç‰¹æ€§
- **å®‰å…¨æ€§**ï¼šå†…ç½®è®¤è¯ã€æˆæƒå’Œé™æµæœºåˆ¶

### æœ€ä½³å®è·µæ€»ç»“
1. **éµå¾ªåˆ†å±‚æ¶æ„**ï¼šä¸¥æ ¼æŒ‰ç…§MVCæ¨¡å¼ç»„ç»‡ä»£ç 
2. **ä½¿ç”¨ä¾èµ–æ³¨å…¥**ï¼šé€šè¿‡Guiceç®¡ç†ç»„ä»¶ä¾èµ–å…³ç³»
3. **æ³¨è§£é©±åŠ¨å¼€å‘**ï¼šä½¿ç”¨æ³¨è§£ç®€åŒ–è·¯ç”±å’Œé…ç½®
4. **å¼‚æ­¥ç¼–ç¨‹æ¨¡å¼**ï¼šå……åˆ†åˆ©ç”¨Vert.xå¼‚æ­¥ç‰¹æ€§
5. **ç»Ÿä¸€å¼‚å¸¸å¤„ç†**ï¼šå…¨å±€å¼‚å¸¸å¤„ç†å’Œå“åº”åŒ…è£…
6. **é…ç½®å¤–éƒ¨åŒ–**ï¼šé€šè¿‡YAMLæ–‡ä»¶ç®¡ç†é…ç½®
7. **ä¸­é—´ä»¶æ¨¡å—åŒ–**ï¼šå¯æ’æ‹”çš„ä¸­é—´ä»¶æ¶æ„
8. **ä»£ç è´¨é‡ä¿è¯**ï¼šè‡ªåŠ¨åŒ–æµ‹è¯•å’Œä»£ç å®¡æŸ¥
